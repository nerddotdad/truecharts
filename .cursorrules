# TrueCharts GitOps Cluster Management Rules

## Core GitOps Principle
**ALL cluster changes MUST be made through configuration files and committed to the repository. Flux will automatically apply changes to the cluster.**

### Required Workflow for Cluster Changes:
1. **Modify configuration files** in the repository (YAML manifests, Helm releases, etc.)
2. **Commit changes** to Git with descriptive commit messages
3. **Push to repository** (typically `main` branch)
4. **Monitor Flux reconciliation** using `kubectl get helmrelease` and `kubectl describe` commands
5. **Validate changes** using `kubectl` commands to verify the desired state

### Tools to Use

- **flux version 2.7.2** flux cli is installed and can be used for checking on all things deployment related.
- **talosctl** my nodes run talos and you can use talosctl to get information about the baremetal os.
    - **client version**: v1.11.3
    - **server versions**: v1.11.2
- **kustomize** is how my repository is mapped
- **clustertool** is a helper script that wraps common talosctl, kubernetes, flux, and other commands for setting up and managing a truecharts cluster.
- **truecharts cluster** is used as the helmchart platform.
    - **truecharts common chart settings** can be found here https://truecharts.org/common/
    - **truecharts public example clusters** can be used to look up examples on how truecharts is used in the wild.
        - https://github.com/alfi0812/talos
        - https://github.com/kqmaverick/cluster
        - https://github.com/PrivatePuffin/cluster
        - https://github.com/xstar97/cluster
        - https://github.com/Boemeltrein/TalosCluster
- **Files and Folders**
    - **talconfig.yaml** Contains your Talos Cluster layout
    - **clusterenv.yaml** Contains configuration options for both your Charts and Talos Cluster
    - **talsecret.yaml** Contains Talos Cluster encryption keys
    - **age.agekey** Contains SOPS encryption keys which can be used to encrypt data. It’s IMPERATIVE you save this specific file elsewhere as a backup, not doing so will result in future data loss
    - **.sops.yaml** Contains specifications on how to decrypt any encrypted files found
    - **.pre-commit-config.yaml** Contains configurations for users of “pre-commit”
    - **talconfig.json** Contains the validations “schema” for talconfig.yaml
    - **/patches/** This folder contains our custom Talos Machine Configuration patches, these should not be altered by any end-user. however, you can add your own here
    - **/generated/** This folder will contain some pre-generated files that will be used to bootstrap the cluster and, if configured, can be consumed by fluxcd for automatic updates and manual configuration
    - **.devcontainer** Contains a preconfigured dev-container for vscode usage of clustertool
    - **.vscode** Contains recommended extensions for your talos cluster in vscode
    - **/repositories/** Contains all repositories used within fluxcd helm-releases
    - **/clusters/** Contains all kubernetes clusters you run within the same clustertool github repo
    - **/kubernetes/** Contains all the files of your kubernetes cluster
    - **/custom_images/** Contains custom Docker images that need to be built (see Custom Images section below)

### Custom Docker Images

When an application requires a custom Docker image (not available as a pre-built image, or needs custom configuration):

1. **Create image directory**: Place all image files in `custom_images/<image-name>/`
   - Must include a `Dockerfile`
   - Include any required source files, scripts, etc.
   - Optionally add a `README.md` with build/usage instructions

2. **Automatic building**: Images are automatically built and pushed to GitHub Container Registry (GHCR) via GitHub Actions:
   - **Trigger**: Automatically on push to `main` when files in `custom_images/` change
   - **Registry**: `ghcr.io/nerddotdad/<image-name>`
   - **Tags**: `latest` (on main branch) and `main-<sha>` (for versioning)
   - **Workflow**: `.github/workflows/build-custom-images.yml`
   - **Manual trigger**: Can be manually triggered via GitHub Actions UI

3. **Using in HelmReleases**: Reference the GHCR image in your HelmRelease:
   ```yaml
   image:
     repository: ghcr.io/nerddotdad/<image-name>
     pullPolicy: IfNotPresent
     tag: "latest"  # or use specific tag like "main-abc123"
   ```

4. **Benefits**:
   - ✅ Pre-installed dependencies = faster pod startup
   - ✅ No build failures during pod initialization
   - ✅ Version controlled Dockerfiles
   - ✅ Automatic builds on changes
   - ✅ Free registry (GHCR is free for public repos)

5. **Example structure**:
   ```
   custom_images/
     └── styletts2/
         ├── Dockerfile
         ├── api_server.py
         └── README.md
   ```

6. **Best practices**:
   - Keep images focused on a single application
   - Include only necessary dependencies
   - Use multi-stage builds when appropriate
   - Document build requirements in README
   - Test images locally before committing

### Prohibited Actions:
- ❌ **NEVER** use `kubectl apply`, `kubectl patch`, or direct cluster modifications
- ❌ **NEVER** manually restart deployments or daemonsets via kubectl
- ❌ **NEVER** edit resources directly in the cluster
- ❌ **NEVER** use `kubectl scale`, `kubectl rollout restart`, or similar commands

### Required Actions:
- ✅ **ALWAYS** edit configuration files in the repository
- ✅ **ALWAYS** commit and push changes to Git
- ✅ **ALWAYS** monitor Flux reconciliation status
- ✅ **ALWAYS** validate changes using kubectl describe/get commands

### Validation Commands:
After making changes, use these commands to verify:
- `kubectl get helmrelease <name> -n <namespace>` - Check Helm release status
- `kubectl describe helmrelease <name> -n <namespace>` - Detailed status and events
- `kubectl get pods -n <namespace>` - Verify pod status
- `kubectl describe pod <pod-name> -n <namespace>` - Check pod details and events
- `kubectl get events -n <namespace> --sort-by='.lastTimestamp'` - Recent events

### GitOps Benefits:
- **Audit trail**: All changes tracked in Git history
- **Rollback capability**: Easy to revert changes
- **Consistency**: Same configuration across environments
- **Automation**: Flux handles deployment automatically
- **Collaboration**: Team members can review changes via pull requests

## Project Structure
This is a TrueCharts GitOps repository using Flux for cluster management. Key directories:
- `clusters/main/kubernetes/` - Kubernetes manifests and Helm releases
- `repositories/` - Helm repository configurations
- `clusters/main/talos/` - Talos Linux configuration
- `custom_images/` - Custom Docker images with automatic build via GitHub Actions
- `.github/workflows/` - GitHub Actions workflows (including custom image builds)

Remember: **Configuration as Code** - If it's not in Git, it doesn't exist!
