clusterName: ${CLUSTERNAME}
# renovate: datasource=docker depName=ghcr.io/siderolabs/installer
talosVersion: v1.11.2
# renovate: datasource=docker depName=ghcr.io/siderolabs/kubelet
kubernetesVersion: v1.32.1
endpoint: https://${VIP}:6443
allowSchedulingOnControlPlanes: true
additionalMachineCertSans:
    - 127.0.0.1
    - ${VIP}
additionalApiServerCertSans:
    - 127.0.0.1
    - ${VIP}
# Warning: Also used in Cilium CNI values!
clusterPodNets:
    - ${PODNET}
clusterSvcNets:
    - ${SVCNET}
cniConfig:
    name: none
patches:
    - '@./patches/all.yaml'
nodes:
    # We would adivce to always stick to a "k8s-something-1" style naming scheme
    - hostname: k8s-control-1
      ipAddress: ${MASTER1IP_IP}
      controlPlane: true
      nameservers:
        - 1.1.1.1
        - 8.8.8.8
      installDiskSelector:
        size: <= 3000GB
      networkInterfaces:
        # suffix is the adapter mac adres.
        - interface: ens3
          addresses:
            - ${MASTER1IP_CIDR}
          routes:
            - network: 0.0.0.0/0
              gateway: ${GATEWAY}
          vip:
            ip: ${VIP}
      schematic:
        customization:
            systemExtensions:
              officialExtensions:
                - siderolabs/util-linux-tools
                - siderolabs/iscsi-tools
                - siderolabs/qemu-guest-agent  # Enabled for VM control plane
                - siderolabs/i915
                - siderolabs/intel-ucode
                - siderolabs/mei
              # - siderolabs/nonfree-kmod-nvidia-lts
              # - siderolabs/nvidia-container-toolkit-lts
      # patches:
      #   - "@./patches/gpu.yaml"
    - hostname: k8s-worker-1
      ipAddress: ${WORKER1IP_IP}
      controlPlane: false
      nameservers:
        - 1.1.1.1
        - 8.8.8.8
      installDiskSelector:
        size: '>= 100GB'
        transport: "nvme"
        # Alternative: If you have multiple NVMe drives, you can specify by model:
        # model: "Samsung SSD 980 PRO 1TB"
        # Or by name if known:
        # name: "nvme0n1"
      networkInterfaces:
        # Realtek 2.5Gbe PCIe adapter
        # Use "ip link" in Talos installer to find the correct interface name
        # Common names: enp4s0, enp5s0, enp6s0, etc.
        - interface: enp3s0
          addresses:
            - ${WORKER1IP_CIDR}
          routes:
            - network: 0.0.0.0/0
              gateway: ${GATEWAY}
      nodeLabels:
        node-type: ai-dedicated
        workload: ai-services
        hardware: ai-machine-1
      # nodeTaints removed: nodes don't have RBAC permission to modify their own taints
      # Apply taints via GitOps/Kubernetes manifests instead if needed
      schematic:
        customization:
          systemExtensions:
            officialExtensions:
              - siderolabs/util-linux-tools
              - siderolabs/iscsi-tools
              # - siderolabs/qemu-guest-agent  # Disabled for physical hardware
              - siderolabs/amd-ucode
              - siderolabs/nonfree-kmod-nvidia-lts
              - siderolabs/nvidia-container-toolkit-lts
              - siderolabs/uinput
      patches:
        - "@./patches/gpu.yaml"
        - "@./patches/ai.yaml"
controlPlane:
    patches:
        - '@./patches/controlplane.yaml'
    kernelModules:
     - name: nvme_tcp
     - name: vfio_pci
     - name: uio_pci_generic
    schematic:
        customization:
            extraKernelArgs:
                - net.ifnames=0
            systemExtensions:
                officialExtensions:
                    - siderolabs/util-linux-tools
                    - siderolabs/iscsi-tools
                    - siderolabs/qemu-guest-agent  # Enabled for VM control plane
    machineFiles:
    - content: |
        [plugins."io.containerd.cri.v1.images"] 
          discard_unpacked_layers = false
      permissions: 0
      path: /etc/cri/conf.d/20-customization.part
      op: create
    - content: |
        [ NFSMount_Global_Options ]
        nfsvers=4.2
        hard=True
        nconnect=16
        noatime=True
      permissions: 420
      path: /etc/nfsmount.conf
      op: overwrite

worker:
    patches:
        - '@./patches/worker.yaml'
    kernelModules:
     - name: nvme_tcp
     - name: vfio_pci
     - name: uio_pci_generic
     - name: r8169  # Realtek 2.5Gbe network driver
     - name: uinput  # Required for Sunshine input support (/dev/uinput)
    schematic:
        customization:
            systemExtensions:
                officialExtensions:
                    - siderolabs/util-linux-tools
                    - siderolabs/iscsi-tools
                    # - siderolabs/qemu-guest-agent  # Disabled for physical hardware
    machineFiles:
    - content: |
        [plugins."io.containerd.cri.v1.images"] 
          discard_unpacked_layers = false
      permissions: 0
      path: /etc/cri/conf.d/20-customization.part
      op: create
    - content: |
        [ NFSMount_Global_Options ]
        nfsvers=4.2
        hard=True
        nconnect=16
        noatime=True
      permissions: 420
      path: /etc/nfsmount.conf
      op: overwrite