---
apiVersion: v1
kind: ConfigMap
metadata:
  name: node-config-script
  namespace: system
data:
  apply-taint.sh: |
    #!/bin/bash
    # Apply taint to AI worker node k8s-worker-1
    # Check if node exists
    if ! kubectl get node k8s-worker-1 &>/dev/null; then
      echo "Node k8s-worker-1 not found"
      exit 0
    fi
    
    # Check if taint already exists
    if kubectl get node k8s-worker-1 -o jsonpath='{.spec.taints[*].key}' | grep -q "ai-only"; then
      echo "Taint ai-only already exists on k8s-worker-1"
      exit 0
    fi
    
    # Apply taint
    kubectl taint node k8s-worker-1 ai-only=1:NoSchedule --overwrite
    echo "Applied taint to k8s-worker-1"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: apply-node-taint
  namespace: system
spec:
  ttlSecondsAfterFinished: 300  # Delete job 5 minutes after completion
  backoffLimit: 3
  template:
    spec:
      serviceAccountName: node-config-sa
      containers:
      - name: kubectl
        image: bitnami/kubectl:latest
        command: ["/bin/bash", "/scripts/apply-taint.sh"]
        volumeMounts:
        - name: scripts
          mountPath: /scripts
      volumes:
      - name: scripts
        configMap:
          name: node-config-script
          defaultMode: 0755
      restartPolicy: OnFailure
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: node-config-sa
  namespace: system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: node-config-role
rules:
- apiGroups: [""]
  resources: ["nodes"]
  verbs: ["get", "list", "patch", "update"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: node-config-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: node-config-role
subjects:
- kind: ServiceAccount
  name: node-config-sa
  namespace: system
