# Element Matrix Server Suite - Advanced Deployment
# Includes: Synapse, Element Web, PostgreSQL, Redis, Jitsi Meet, Coturn
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: element-advanced
  namespace: communication
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 15.22.4
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
  values:
    # Main Synapse Homeserver Configuration
    image:
      repository: matrixdotorg/synapse
      pullPolicy: IfNotPresent
      tag: v1.108.0
    
    securityContext:
      container:
        readOnlyRootFilesystem: false
    
    workload:
      main:
        dbWait: true
        podSpec:
          initContainers:
            setup:
              enabled: true
              image:
                repository: busybox
                tag: latest
              command:
                - /bin/sh
                - -c
                - |
                  mkdir -p /data/media_store /data/uploads
                  chown -R 568:568 /data
                  chmod -R 755 /data
              volumeMounts:
                - name: config
                  mountPath: /data
                - name: media
                  mountPath: /data/media_store
          containers:
            main:
              enabled: true
              probes:
                startup:
                  enabled: true
                  type: http
                  port: 8008
                  path: /_matrix/client/versions
                  initialDelaySeconds: 60
                  periodSeconds: 10
                  failureThreshold: 10
                liveness:
                  enabled: true
                  type: http
                  port: 8008
                  path: /_matrix/client/versions
                  periodSeconds: 30
                  failureThreshold: 3
                readiness:
                  enabled: true
                  type: http
                  port: 8008
                  path: /_matrix/client/versions
                  periodSeconds: 10
                  failureThreshold: 3
              command:
                - /bin/bash
                - -c
                - |
                  if [ ! -f /data/homeserver.yaml ]; then
                    echo "Generating Synapse configuration..."
                    python -m synapse.app.homeserver \
                      --server-name matrix.${DOMAIN_0} \
                      --config-path /data/homeserver.yaml \
                      --generate-config \
                      --report-stats=no
                  fi
                  echo "Starting Synapse..."
                  python -m synapse.app.homeserver --config-path /data/homeserver.yaml
              env:
                # Synapse Configuration
                SYNAPSE_SERVER_NAME: matrix.${DOMAIN_0}
                SYNAPSE_REPORT_STATS: "no"
                SYNAPSE_ENABLE_REGISTRATION: "true"
                SYNAPSE_ENABLE_REGISTRATION_WITHOUT_VERIFICATION: "true"
                # Database Configuration
                SYNAPSE_DATABASE_TYPE: "psycopg2"
                SYNAPSE_DATABASE_ARGS: "host=element-advanced-postgresql.communication.svc.cluster.local port=5432 user=synapse password=${ELEMENT_DB_PASSWORD} dbname=synapse"
                # Redis Configuration
                SYNAPSE_REDIS_HOST: "element-advanced-redis.communication.svc.cluster.local"
                SYNAPSE_REDIS_PORT: "6379"
                SYNAPSE_REDIS_PASSWORD: "${ELEMENT_REDIS_PASSWORD}"
                SYNAPSE_LOG_LEVEL: "INFO"
                SYNAPSE_LOG_CONFIG: "/data/homeserver.log.config"
                # Media Repository
                SYNAPSE_MEDIA_STORE_PATH: "/data/media_store"
                SYNAPSE_UPLOADS_PATH: "/data/uploads"
                # Federation
                SYNAPSE_FEDERATION_DOMAIN_WHITELIST: ""
                # Registration
                SYNAPSE_REGISTRATION_SHARED_SECRET: "${ELEMENT_REGISTRATION_SECRET}"
                # Jitsi Integration
                SYNAPSE_JITSI_DOMAIN: "meet.${DOMAIN_0}"
                SYNAPSE_JITSI_APP_ID: "element"
                SYNAPSE_JITSI_APP_SECRET: "${ELEMENT_JITSI_SECRET}"
              resources:
                requests:
                  memory: "512Mi"
                  cpu: "250m"
                limits:
                  memory: "2Gi"
                  cpu: "1000m"
    
    # PostgreSQL Database (simplified configuration)
    postgresql:
      enabled: true
      auth:
        postgresPassword: "${ELEMENT_DB_ROOT_PASSWORD}"
        username: "synapse"
        password: "${ELEMENT_DB_PASSWORD}"
        database: "synapse"
      primary:
        persistence:
          enabled: true
          size: "20Gi"
          storageClass: "longhorn"
    
    # Redis Cache (using TrueCharts Redis integration)
    redis:
      enabled: true
      password: "${ELEMENT_REDIS_PASSWORD}"
      master:
        persistence:
          enabled: true
          size: "5Gi"
          storageClass: "longhorn"
    
    # Persistence for Synapse data
    persistence:
      config:
        enabled: true
        mountPath: /data
        size: 10Gi
        storageClass: "longhorn"
      media:
        enabled: true
        mountPath: /data/media_store
        size: 50Gi
        storageClass: "longhorn"
    
    # Service Configuration
    service:
      main:
        enabled: true
        ports:
          main:
            enabled: true
            port: 8008
            targetPort: 8008
            protocol: http
    
    # Ingress Configuration
    ingress:
      main:
        enabled: true
        ingressClassName: external
        hosts:
          - host: matrix.${DOMAIN_0}
            paths:
              - path: /
                pathType: Prefix
        integrations:
          traefik:
            enabled: false
          certManager:
            enabled: true
            certificateIssuer: "domain-0-le-prod"
          homepage:
            enabled: true
            name: Element Matrix
            description: Secure Matrix communication platform
            group: "{{ .Release.Namespace }}"
            icon: "matrix"
            widget:
              custom:
                key: ${HP_ELEMENT}
    
    # Addon: Element Web Client
    addons:
      element-web:
        enabled: true
        image:
          repository: vectorim/element-web
          tag: v1.11.112
        service:
          enabled: true
          ports:
            main:
              port: 80
              targetPort: 80
              protocol: http
        ingress:
          enabled: true
          ingressClassName: external
          hosts:
            - host: element.${DOMAIN_0}
              paths:
                - path: /
                  pathType: Prefix
          integrations:
            certManager:
              enabled: true
              certificateIssuer: "domain-0-le-prod"
            homepage:
              enabled: true
              name: Element Web
              description: Matrix web client
              group: "{{ .Release.Namespace }}"
              icon: "element"
        env:
          REACT_APP_HOMESERVER_URL: "https://matrix.${DOMAIN_0}"
          REACT_APP_DEFAULT_SERVER_NAME: "matrix.${DOMAIN_0}"
          REACT_APP_JITSI_DOMAIN: "meet.${DOMAIN_0}"
      
      # Addon: Jitsi Meet for Video Conferencing
      jitsi-meet:
        enabled: true
        image:
          repository: jitsi/web
          tag: latest
        service:
          enabled: true
          ports:
            main:
              port: 80
              targetPort: 80
              protocol: http
        ingress:
          enabled: true
          ingressClassName: external
          hosts:
            - host: meet.${DOMAIN_0}
              paths:
                - path: /
                  pathType: Prefix
          integrations:
            certManager:
              enabled: true
              certificateIssuer: "domain-0-le-prod"
            homepage:
              enabled: true
              name: Jitsi Meet
              description: Video conferencing platform
              group: "{{ .Release.Namespace }}"
              icon: "jitsi"
        env:
          PUBLIC_URL: "https://meet.${DOMAIN_0}"
          ENABLE_WELCOME_PAGE: "false"
          ENABLE_LETSENCRYPT: "false"
          LETSENCRYPT_DOMAIN: "meet.${DOMAIN_0}"
          LETSENCRYPT_EMAIL: "${ELEMENT_ADMIN_EMAIL}"
      
      # Addon: Coturn TURN Server
      coturn:
        enabled: true
        image:
          repository: coturn/coturn
          tag: latest
        service:
          enabled: true
          ports:
            main:
              port: 3478
              targetPort: 3478
              protocol: udp
            alt:
              port: 5349
              targetPort: 5349
              protocol: tcp
        env:
          TURN_USERNAME: "${ELEMENT_TURN_USERNAME}"
          TURN_PASSWORD: "${ELEMENT_TURN_PASSWORD}"
          TURN_REALM: "matrix.${DOMAIN_0}"
          TURN_SERVER_NAME: "matrix.${DOMAIN_0}"
          TURN_EXTERNAL_IP: "${ELEMENT_EXTERNAL_IP}"
