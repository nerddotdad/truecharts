# CNPG PostgreSQL instance for Element Server Suite
# This replaces the internal PostgreSQL with CNPG for better backup management
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: element-postgresql
  namespace: communication
spec:
  instances: 1
  
  # PostgreSQL configuration
  postgresql:
    parameters:
      max_connections: "200"
      # Note: shared_preload_libraries is a fixed parameter managed by CNPG and cannot be set
  
  # Storage configuration
  storage:
    size: 20Gi
    storageClass: longhorn
  
  # Backup configuration
  backup:
    barmanObjectStore:
      destinationPath: s3://${CLOUDFLARE_R2_BUCKET_PREFIX}-element-postgres
      endpointURL: ${CLOUDFLARE_R2_URL}
      s3Credentials:
        accessKeyId:
          name: element-backup-credentials
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: element-backup-credentials
          key: SECRET_ACCESS_KEY
      wal:
        compression: gzip
    retentionPolicy: "7d"
  
  # Bootstrap configuration
  bootstrap:
    initdb:
      database: synapse
      owner: synapse
      secret:
        name: element-postgresql-credentials
      postInitSQL:
        - |
          CREATE DATABASE mas OWNER synapse;
          GRANT ALL PRIVILEGES ON DATABASE mas TO synapse;
