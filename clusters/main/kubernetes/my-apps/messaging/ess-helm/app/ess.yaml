apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: matrix-stack
  namespace: messaging
spec:
  interval: 5m
  chart:
    spec:
      chart: matrix-stack
      sourceRef:
        kind: HelmRepository
        name: element-hq
        namespace: flux-system
  values:
    components:
      - synapse
      - element-web
      - element-call
      - coturn

    overrides:
      synapse:
        server_name: "hoth.systems"
        public_baseurl: "https://matrix.hoth.systems"

      element-web:
        default_server_config:
          "m.homeserver":
            base_url: "https://matrix.hoth.systems"
            server_name: "hoth.systems"

      element-call:
        TURN:
          urls:
            - "turn:turn.hoth.systems?transport=udp"
            - "turn:turn.hoth.systems?transport=tcp"
          username: your-turn-username
          credential: your-turn-password

    global:
      ingress:
        enabled: false
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: synapse
  namespace: messaging
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    cert-manager.io/cluster-issuer: domain-0-le-prod
    cert-manager.io/private-key-rotation-policy: Always
spec:
  rules:
    - host: matrix.${DOMAIN_0}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: ess-synapse
                port:
                  number: 8008
  tls:
    - hosts:
      - matrix.${DOMAIN_0}
      secretName: matrix-tls-0