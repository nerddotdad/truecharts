apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: coturn
  namespace: social
spec:
  interval: 1m
  chart:
    spec:
      chart: app-template
      version: 14.5.3
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
  values:
    image:
      repository: instrumentisto/coturn
      tag: latest
      pullPolicy: IfNotPresent

    workload:
      main:
        podSpec:
          volumes:
            - name: coturn-config
              configMap:
                name: coturn-config
          containers:
            main:
              # (existing env, ports, etcâ€¦)
              volumeMounts:
                - name: coturn-config
                  mountPath: /etc/turnserver.conf
                  subPath: turnserver.conf
                  readOnly: true

    service:
      main:
        enabled: true
        type: LoadBalancer
        loadBalancerIP: ${COLTURN_IP}
        ports:
          main:
            enabled: true
            port: 3478
            protocol: udp
            targetPort: 3478

    cnpg:
      main:
        enabled: true
        user: coturn
        database: coturn
        password: ${POSTGRES_PASWORD}
        cluster:
          storage:
            size: 8Gi 

    configmap:
      coturn-config:
        enabled: true
        data:
          turnserver.conf: |
            listening-port=3478
            tls-listening-port=5349
            fingerprint
            
            # secret for HMAC auth
            use-auth-secret
            static-auth-secret=${COLTURN_STATIC_AUTH_SECRET}
            
            realm=matrix.hoth.systems
            
            # PostgreSQL userdb
            userdb=postgresql
            psql-userdb="host=matrix-app-template-cnpg-main-rw \
             dbname=coturn user=coturn password=${POSTGRES_PASWORD} sslmode=disable"
            
            # relay port range
            min-port=49160
            max-port=49200
            relay-threads=4

    persistence:
      config:
        enabled: true
        type: configmap
        objectName: coturn-config
        mountPath: /etc