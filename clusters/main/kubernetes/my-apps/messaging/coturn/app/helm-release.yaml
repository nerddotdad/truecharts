apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: coturn
  namespace: social
spec:
  interval: 1m
  chart:
    spec:
      chart: app-template
      version: 14.5.3
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
  values:
    image:
      repository: instrumentisto/coturn
      tag: latest
      pullPolicy: IfNotPresent

    service:
      main:
        enabled: true
        type: LoadBalancer
        loadBalancerIP: ${COLTURN_IP}
        ports:
          main:
            enabled: true
            port: 3478
            protocol: udp
            targetPort: 3478

    cnpg:
      main:
        enabled: true
        user: colturn
        database: colturn
        password: ${POSTGRES_PASWORD}
        cluster:
          storage:
            size: 8Gi 

    configmap:
      coturn-config:
        enabled: true
        data:
          turnserver.conf: |
            realm=matrix.hoth.systems
            use-auth-secret
            static-auth-secret=${COLTURN_STATIC_AUTH_SECRET}
            userdb=postgresql
            psql-userdb="host=matrix-app-template-cnpg-main-rw dbname=coturn user=coturn password=${POSTGRES_PASWORD}"

    persistence:
      config:
        enabled: true
        mountPath: /config
        type: configmap
        objectName: coturn-config