apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: coturn
  namespace: social
spec:
  interval: 1m
  chart:
    spec:
      chart: app-template
      version: 14.5.3
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
  values:
    image:
      repository: coturn/coturn
      tag: latest
      pullPolicy: IfNotPresent

    workload:
      main:
        podSpec:
          containers:
            main:
              # override the entrypoint (optional) and pass args:
              # if the image already uses `turnserver` as entrypoint, you only need args:
              args:
                - -n
                - --log-file=stdout
                - --min-port=49160
                - --max-port=49200
                - --lt-cred-mech
                - --fingerprint
                - --no-multicast-peers
                - --no-cli
                - --no-tlsv1
                - --no-tlsv1_1
                - --realm=matrix.hoth.systems
                - --use-auth-secret
                - --static-auth-secret=${COLTURN_STATIC_AUTH_SECRET}
                - --listening-port=3478
                - --tls-listening-port=5349
                - --userdb=postgresql
                - --psql-userdb=host=coturn-app-template-cnpg-main-rw\ dbname=coturn\ user=coturn\ password=${POSTGRES_PASWORD}\ sslmode=disable

    service:
      main:
        enabled: true
        type: LoadBalancer
        loadBalancerIP: ${COLTURN_IP}
        ports:
          udp3478:
            enabled: true
            port: 3478
            protocol: UDP
            targetPort: 3478
          tcp3478:
            enabled: true
            port: 3478
            protocol: TCP
            targetPort: 3478

    cnpg:
      main:
        enabled: true
        user: coturn
        database: coturn
        password: ${POSTGRES_PASWORD}
        cluster:
          storage:
            size: 8Gi
