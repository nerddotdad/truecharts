apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: wow
  namespace: gaming
spec:
  interval: 5m
  chart:
    spec:
      chart: app-template
      version: 14.5.3
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
  values:
    image:
      repository: nerddotdad/azerothcore-runtime
      pullPolicy: IfNotPresent
      tag: v0.0.10

    persistence:
      config:
        enabled: true
        mountPath: /azerothcore/build/dist/etc/
        # Corrected targetSelector to directly map subcontainers (no duplicate keys)
        targetSelector:
          main:
            mountPath: /azerothcore/build/dist/etc/
          init-copy:
            mountPath: /azerothcore/build/dist/etc/

      ac-configmap-vol:
        enabled: true
        type: configmap
        objectName: azerothcore-configmap
        mountPath: /tmp/configs
        items:
          - key: authserver.conf
            path: authserver.conf
          - key: worldserver.conf
            path: worldserver.conf
        targetSelector:
          main:
            mountPath: /tmp/configs
          init-copy:
            mountPath: /tmp/configs

    workload:
      main:
        podSpec:
          initContainers:
            init-copy:
              enabled: true
              type: init
              imageSelector: alpineImage
              command:
                - /bin/sh
                - -c
                - |
                  echo "Copying config files..."
                  cp /tmp/authserver.conf /azerothcore/build/dist/etc/authserver.conf
                  cp /tmp/worldserver.conf /azerothcore/build/dist/etc/worldserver.conf

    configmap:
      azerothcore-configmap:
        enabled: true
        data:
          authserver.conf: |
            LoginDatabaseInfo = "mysql://ac_user:password@db/acore_auth"
            LogLevel = 3
            BindIP = "0.0.0.0"
            RealmListPort = 3724

          worldserver.conf: |
            WorldDatabaseInfo = "mysql://ac_user:password@db/acore_world"
            CharacterDatabaseInfo = "mysql://ac_user:password@db/acore_characters"
            LoginDatabaseInfo = "mysql://ac_user:password@db/acore_auth"
            HotReload = 1
            BindIP = "0.0.0.0"
            WorldServerPort = 8085

    service:
      main:
        enabled: true
        type: LoadBalancer
        loadBalancerIP: ${WOW_IP}
        ports:
          main:
            enabled: true
            protocol: tcp
            port: 8085
            targetPort: 8085
          auth:
            enabled: true
            protocol: tcp
            port: 3724
            targetPort: 3724
