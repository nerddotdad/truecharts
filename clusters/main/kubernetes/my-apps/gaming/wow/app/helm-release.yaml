apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: wow
  namespace: gaming
spec:
  interval: 5m
  chart:
    spec:
      chart: app-template
      version: 14.5.3
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
  values:
    image:
      repository: nerddotdad/azerothcore-runtime
      pullPolicy: IfNotPresent
      tag: v0.0.12

    workload:
      main:
        podSpec:
          probes:
            startup:
              enabled: true
              type: tcp
              port: 8085
              initialDelaySeconds: 30
              periodSeconds: 10
              failureThreshold: 10
            liveness:
              enabled: true
              type: tcp
              port: 8085
              periodSeconds: 10
              failureThreshold: 5
            readiness:
              enabled: true
              type: tcp
              port: 8085
              periodSeconds: 10
              failureThreshold: 3
          containers:
            main:
              enabled: true
              env:
                ACORE_AUTH_HOST: wow-mariadb.gaming.svc.cluster.local
                ACORE_AUTH_DB: acore_auth
                ACORE_AUTH_USER: ac_user
                ACORE_WORLD_HOST: wow-mariadb.gaming.svc.cluster.local
                ACORE_WORLD_DB: acore_world
                ACORE_WORLD_USER: ac_user
                ACORE_CHARACTERS_HOST: wow-mariadb.gaming.svc.cluster.local
                ACORE_CHARACTERS_DB: acore_characters
                ACORE_CHARACTERS_USER: ac_user
                ACORE_WORLD_PASS:
                  secretKeyRef:
                    name: wow-mariadbcreds
                    key: mariadb-password
                    expandObjectName: false
                ACORE_AUTH_PASS:
                  secretKeyRef:
                    name: wow-mariadbcreds
                    key: mariadb-password
                    expandObjectName: false
                ACORE_CHARACTERS_PASS:
                  secretKeyRef:
                    name: wow-mariadbcreds
                    key: mariadb-password
                    expandObjectName: false
          initContainers:
            copy-configs:
              enabled: true
              type: init
              imageSelector: alpineImage
              command:
                - /bin/sh
                - -c
                - |
                  echo "checking files"
                  cd /azerothcore && ls -ltrhR

    persistence:
      config:
        enabled: true
        type: configmap
        objectName: azerothcore-configmap
        mountPath: /azerothcore/build/dist/etc
        items:
          - key: authserver.conf
            path: authserver.conf
          - key: worldserver.conf
            path: worldserver.conf
        targetSelector:
          main:
            main:
              mountPath: /azerothcore/build/dist/etc
            copy-configs:
              mountPath: /azerothcore/build/dist/etc


      # ac-configmap-vol:
      #   enabled: true
      #   type: configmap
      #   objectName: azerothcore-configmap
      #   mountPath: /tmp/configs
      #   items:
      #     - key: authserver.conf
      #       path: authserver.conf
      #     - key: worldserver.conf
      #       path: worldserver.conf
      #   targetSelector:
      #     main:
      #       copy-configs:
      #         mountPath: /tmp/configs

    configmap:
      azerothcore-configmap:
        enabled: true
        data:
          authserver.conf: ""

          worldserver.conf: ""

    service:
      main:
        enabled: true
        type: LoadBalancer
        loadBalancerIP: ${WOW_IP}
        ports:
          main:
            enabled: true
            protocol: tcp
            port: 8085
            targetPort: 8085
          auth:
            enabled: true
            protocol: tcp
            port: 3724
            targetPort: 3724

    mariadb:
      enabled: true
      includeCommon: true
      creds:
        auth: acore_auth
        characters: acore_characters
        world: acore_world

---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: wow-mariadb
  namespace: gaming
spec:
  interval: 5m
  chart:
    spec:
      chart: mariadb
      version: 15.9.0  # adjust to your desired version
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
  values:
    configmap:
      passinit:
        enabled: true
        data:
          passinit.sql: |
            CREATE DATABASE IF NOT EXISTS acore_auth CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
            CREATE DATABASE IF NOT EXISTS acore_world CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
            CREATE DATABASE IF NOT EXISTS acore_characters CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

            CREATE USER 'ac_user'@'%' IDENTIFIED BY 'PLACEHOLDERPASSWORD';
            GRANT ALL PRIVILEGES ON acore_auth.* TO 'ac_user'@'%';
            GRANT ALL PRIVILEGES ON acore_world.* TO 'ac_user'@'%';
            GRANT ALL PRIVILEGES ON acore_characters.* TO 'ac_user'@'%';
            FLUSH PRIVILEGES;
    mariadbUsername: "ac_user"
    mariadbDatabase: "wow-mariadb"