apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: wow
  namespace: gaming
spec:
  interval: 5m
  chart:
    spec:
      chart: app-template
      version: 14.5.3
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
  values:
    image:
      repository: nerddotdad/azerothcore-runtime
      pullPolicy: IfNotPresent
      tag: v0.0.10

    persistence:
      config:
        enabled: true
        mountPath: /azerothcore/build/dist/etc/
        targetSelector:
          main:
            main:
              mountPath: /azerothcore/build/dist/etc/
            init-copy:
              mountPath: /azerothcore/build/dist/etc/

      ac-configmap-vol:
        enabled: true
        type: configmap
        objectName: azerothcore-configmap
        mountPath: /tmp/configs
        items:
          - key: authserver.conf
            path: authserver.conf
          - key: worldserver.conf
            path: worldserver.conf
        targetSelector:
          main:
            init-copy:
              mountPath: /tmp/configs

    workload:
      main:
        podSpec:
          probes:
            startup:
              enabled: true
              type: TCP
              port: 8085
              initialDelaySeconds: 30
              periodSeconds: 10
              failureThreshold: 10
            liveness:
              enabled: true
              type: TCP
              port: 8085
              periodSeconds: 10
              failureThreshold: 5
            readiness:
              enabled: true
              type: TCP
              port: 8085
              periodSeconds: 10
              failureThreshold: 3
          initContainers:
            copy-configs:
              enabled: true
              type: init
              imageSelector: alpineImage
              command:
                - /bin/sh
                - -c
                - |
                  echo "Copying config files..."
                  cd /tmp/configs
                  cp authserver.conf /azerothcore/build/dist/etc/authserver.conf && \
                  cp worldserver.conf /azerothcore/build/dist/etc/worldserver.conf && \
                  echo "authserver.conf and worldserver.conf copied successfully."
            # mariadb:
            #   enabled: true
            #   type: init
            #   imageSelector: mariadb
            #   command:
            #     CREATE DATABASE IF NOT EXISTS acore_auth;
            #     CREATE DATABASE IF NOT EXISTS acore_world;
            #     CREATE DATABASE IF NOT EXISTS acore_characters;

            #     CREATE USER 'ac_user'@'%' IDENTIFIED BY 'password';
            #     GRANT ALL PRIVILEGES ON acore_auth.* TO 'ac_user'@'%';
            #     GRANT ALL PRIVILEGES ON acore_world.* TO 'ac_user'@'%';
            #     GRANT ALL PRIVILEGES ON acore_characters.* TO 'ac_user'@'%';
            #     FLUSH PRIVILEGES;

    configmap:
      azerothcore-configmap:
        enabled: true
        data:
          authserver.conf: |
            LoginDatabaseInfo = "mysql://ac_user:password@wow-mariadb/acore_auth"
            BindIP = "0.0.0.0"
            RealmListPort = 3724

            Loggers = ""
            Logger.root=3,Console
            Logger.server=6,Console
            Logger.sql.sql=6,Console

          worldserver.conf: |
            WorldDatabaseInfo = "mysql://ac_user:password@wow-mariadb/acore_world"
            CharacterDatabaseInfo = "mysql://ac_user:password@wow-mariadb/acore_characters"
            LoginDatabaseInfo = "mysql://ac_user:password@wow-mariadb/acore_auth"
            HotReload = 1
            BindIP = "0.0.0.0"
            WorldServerPort = 8085
            
            Loggers = ""
            Logger.root=3,Console
            Logger.server=6,Console
            Logger.sql.sql=6,Console
      azerothcore-init-sql:
        enabled: true
        data:
          init.sql: |
            CREATE DATABASE IF NOT EXISTS acore_auth;
            CREATE DATABASE IF NOT EXISTS acore_world;
            CREATE DATABASE IF NOT EXISTS acore_characters;

            CREATE USER 'ac_user'@'%' IDENTIFIED BY 'password';
            GRANT ALL PRIVILEGES ON acore_auth.* TO 'ac_user'@'%';
            GRANT ALL PRIVILEGES ON acore_world.* TO 'ac_user'@'%';
            GRANT ALL PRIVILEGES ON acore_characters.* TO 'ac_user'@'%';
            FLUSH PRIVILEGES;

    service:
      main:
        enabled: true
        type: LoadBalancer
        loadBalancerIP: ${WOW_IP}
        ports:
          main:
            enabled: true
            protocol: tcp
            port: 8085
            targetPort: 8085
          auth:
            enabled: true
            protocol: tcp
            port: 3724
            targetPort: 3724

    mariadb:
      enabled: true
      includeCommon: true
      creds:
        auth: acore_auth
        characters: acore_characters
        world: acore_world

---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: wow-mariadb
  namespace: gaming
spec:
  interval: 5m
  chart:
    spec:
      chart: mariadb
      version: 15.9.0  # adjust to your desired version
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system

values:
  mariadbUsername: "test"
  mariadbDatabase: "test"