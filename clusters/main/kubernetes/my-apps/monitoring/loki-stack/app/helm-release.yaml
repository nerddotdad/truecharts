---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: loki
  namespace: monitoring
spec:
  interval: 5m
  chart:
    spec:
      chart: loki-stack
      version: 2.10.2
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
  timeout: 20m
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    test_pod:
      enabled: true
      image: bats/bats:1.11.1
      pullPolicy: IfNotPresent

    loki:
      enabled: true
      url: http://loki:3100
      limits_config:
        volume_enabled: true
      datasource:
        jsonData: "{}"
        uid: ""
      readinessProbe:
        httpGet:
          path: /ready
          port: 3100
        initialDelaySeconds: 45
      livenessProbe:
        httpGet:
          path: /ready
          port: 3100
        initialDelaySeconds: 45

    promtail:
      enabled: true
      config:
        logLevel: info
        serverPort: 3101
        clients:
          - url: http://loki:3100/loki/api/v1/push
        positions:
          filename: /run/promtail/positions.yaml
        rbac:
          create: true 

    fluent-bit:
      enabled: false

    grafana:
      enabled: false
      sidecar:
        datasources:
          label: ""
          labelValue: ""
          enabled: true
          maxLines: 1000
      image:
        tag: 10.3.3

    prometheus:
      enabled: false

    filebeat:
      enabled: false

    logstash:
      enabled: false

    # proxy is currently only used by loki test pod
    # Note: If http_proxy/https_proxy are set, then no_proxy should include the
    # loki service name, so that tests are able to communicate with the loki
    # service.
    proxy:
      http_proxy: ""
      https_proxy: ""
      no_proxy: ""