---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: loki
  namespace: monitoring
spec:
  interval: 5m
  chart:
    spec:
      chart: loki-stack
      version: 2.10.2
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
  timeout: 20m
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    loki:
      enabled: true
      config:
        auth_enabled: false
        server:
          http_listen_port: 3100
        limits_config:
          allow_structured_metadata: true
          volume_enabled: true
        schema_config:
          configs:
            - from: 2022-01-01
              store: boltdb-shipper
              object_store: filesystem
              schema: v11
              index:
                prefix: index_
                period: 24h
        storage_config:
          boltdb_shipper:
            active_index_directory: /data/loki/index
            shared_store: filesystem
          filesystem:
            directory: /data/loki/chunks
      readinessProbe:
        httpGet:
          path: /ready
          port: 3100
        initialDelaySeconds: 45
      livenessProbe:
        httpGet:
          path: /ready
          port: 3100
        initialDelaySeconds: 45

    promtail:
      enabled: true
      config:
        logLevel: info
        serverPort: 3101
        clients:
          - url: http://loki.monitoring.svc.cluster.local:3100
        positions:
          filename: /run/promtail/positions.yaml
      rbac:
        create: true

    fluent-bit:
      enabled: false

    grafana:
      enabled: false

    prometheus:
      enabled: false

    filebeat:
      enabled: false

    logstash:
      enabled: false

    proxy:
      http_proxy: ""
      https_proxy: ""
      no_proxy: ""
