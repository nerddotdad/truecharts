apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: loki
  namespace: monitoring
spec:
  interval: 15m
  timeout: 5m
  chart:
    spec:
      chart: loki
      version: 3.10.0
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
      interval: 15m
  values:
    loki:
      commonConfig:
        replication_factor: 1
      schemaConfig:
        configs:
          - from: "2024-04-01"
            store: boltdb-shipper
            object_store: filesystem
            schema: v13
            index:
              prefix: loki_index_
              period: 24h
            filesystem:
              directory: /mnt/loki  # This is where NFS is mounted
      limits_config:
        allow_structured_metadata: true
        volume_enabled: true
      ruler:
        enable_api: true
      minio:
        enabled: false
      deploymentMode: SingleBinary
      singleBinary:
        replicas: 1
      # Zero out replica counts of other deployment modes
      backend:
        replicas: 0
      read:
        replicas: 0
      write:
        replicas: 0
      ingester:
        replicas: 0
      querier:
        replicas: 0
      queryFrontend:
        replicas: 0
      queryScheduler:
        replicas: 0
      distributor:
        replicas: 0
      compactor:
        replicas: 0
      indexGateway:
        replicas: 0
      bloomCompactor:
        replicas: 0
      bloomGateway:
        replicas: 0
    # Define volume and volume mounts for Loki container
    podSpec:
      volumes:
        - name: loki-storage
          nfs:
            server: ${NAS_IP}  # Replace with the correct server IP or handle via environment variable
            path: /mnt/vault/app-configs/loki  # NFS path on the server
      volumeMounts:
        - mountPath: /mnt/loki  # Mount the NFS volume to this path inside the Loki container
          name: loki-storage
