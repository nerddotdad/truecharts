---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: sonarr
  namespace: downloaders
spec:
  interval: 15m
  chart:
    spec:
      chart: sonarr
      version: 23.5.0
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
      interval: 15m
  timeout: 20m
  maxHistory: 3
  driftDetection:
    mode: warn
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    # credentials:
    #   cloudflare_r2:
    #       type: s3
    #       url: ${CLOUDFLARE_R2_URL}
    #       bucket: ${CLOUDFLARE_R2_BUCKET_PREFIX}-{{ .Chart.Name }}
    #       accessKey: ${CLOUDFLARE_R2_KEY_ID}
    #       secretKey: ${CLOUDFLARE_R2_ACESS_KEY}
    #       encrKey: ${CLOUDFLARE_R2_ENCRKEY}
    persistence:
        # config:
        #     volsync:
        #         - name: config
        #           type: restic
        #           credentials: cloudflare_r2
        #           dest:
        #             enabled: true
        #           src:
        #             enabled: true
        config: # this is the target location for media
            enabled: true
            type: nfs
            mountPath: /config
            path: /mnt/Applications/apps-configs/sonarr
            server:  ${NAS_IP}
        target: # this is the target location for media
            enabled: true
            type: nfs
            mountPath: /data/media
            path: /mnt/hhd-hc-primary/media/data/media
            server:  ${NAS_IP}
        nzbget-target: # this is the target location for nzbget
            enabled: true
            type: nfs
            mountPath: /config/downloads
            path: /mnt/hhd-hc-primary/media/data/usenet
            server:  ${NAS_IP}
    ingress:
        main:
            enabled: true
            hosts:
                - host: sonarr.${DOMAIN_0}
                  paths:
                    - path: /
                      pathType: Prefix
            integrations:
                certManager:
                    enabled: true
                    certificateIssuer: domain-0-le-prod
                traefik:
                    enabled: true
                    entrypoints:
                        - websecure
                homepage:
                    enabled: true
                    name: Sonarr
                    description: This is a sonarr instance
                    group: Media
                    icon: ""
                    widget:
                      type: sonarr
                      url: https://sonarr.media.svc.cluster.local