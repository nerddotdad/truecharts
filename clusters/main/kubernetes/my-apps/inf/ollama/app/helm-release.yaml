apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: ollama
  namespace: inf
spec:
  interval: 15m
  chart:
    spec:
      chart: ollama
      version: 8.1.1
      sourceRef:
        kind: HelmRepository
        name: truecharts
        namespace: flux-system
      interval: 15m
  timeout: 5m
  maxHistory: 3
  driftDetection:
    mode: warn
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
workload:
  main:
    podSpec:
      containers:
        main:
          imageSelector: image
          resources:
            limits:
              gpu.intel.com/i915: 1
          probes:
            liveness:
              enabled: true
              type: http
              path: /api/version
              port: "{{ .Values.service.api.ports.api.targetPort }}"
            readiness:
              enabled: true
              type: http
              path: /api/version
              port: "{{ .Values.service.api.ports.api.targetPort }}"
            startup:
              enabled: true
              type: tcp
              port: "{{ .Values.service.api.ports.api.targetPort }}"
        ui:
          enabled: true
          type: Deployment
          podSpec:
            containers:
              ui:
                primary: true
                enabled: true
                imageSelector: uiImage
                resources:
                  excludeExtra: true
                probes:
                  liveness:
                    enabled: true
                    type: http
                    path: /
                    port: "{{ .Values.service.main.ports.main.port }}"
                  readiness:
                    enabled: true
                    type: http
                    path: /
                    port: "{{ .Values.service.main.ports.main.port }}"
                  startup:
                    enabled: true
                    type: tcp
                    port: "{{ .Values.service.main.ports.main.port }}"
                env:
                  PORT: "{{ .Values.service.main.ports.main.port }}"
                  OLLAMA_BASE_URL: '{{ printf "http://%v-api:%v" (include "tc.v1.common.lib.chart.names.fullname" $) .Values.service.api.ports.api.targetPort }}'
                  WEBUI_SECRET_KEY:
                    secretKeyRef:
                      name: ollama-secrets
                      key: WEBUI_SECRET_KEY
                  AUTOMATIC1111_BASE_URL: "{{ .Values.ollama.stable_diffusion.base_url }}"
                  ENABLE_SIGNUP: "{{ .Values.ollama.registration.enabled }}"
                  DEFAULT_USER_ROLE: "{{ .Values.ollama.registration.def_user_role }}"
                  WHISPER_MODEL: "{{ .Values.ollama.whisper.model }}"
                  RAG_EMBEDDING_MODEL: "{{ .Values.ollama.rag.model }}"
                  RAG_EMBEDDING_MODEL_DEVICE_TYPE: "{{ .Values.ollama.rag.model_device_type }}"
                  WEBUI_AUTH_TRUSTED_EMAIL_HEADER: "{{ .Values.ollama.registration.trusted_email_header }}"
                  # OPENAI_API_BASE_URL
                  # OPENAI_API_KEY
                  # DEFAULT_MODELS


      ingress:
        enabled: true
        ui:
          primary: true
          enabled: true
          ingressClassName: internal
          hosts: 
            - host: ollama.${DOMAIN_0}
              paths:
                - path: /
                  pathType: Prefix
          integrations:
            traefik:
              enabled: false
            certManager:
              enabled: true
              certificateIssuer: "domain-0-le-prod"